{"version":3,"sources":["../../../../src/run/ios/runIosAsync.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport spawnAsync from '@expo/spawn-async';\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport path from 'path';\n\nimport * as Log from '../../log';\nimport { hasDirectDevClientDependency } from '../../start/detectDevClient';\nimport { AppleAppIdResolver } from '../../start/platforms/ios/AppleAppIdResolver';\nimport { maybePromptToSyncPodsAsync } from '../../utils/cocoapods';\nimport { setNodeEnv } from '../../utils/nodeEnv';\nimport { ensurePortAvailabilityAsync } from '../../utils/port';\nimport { profile } from '../../utils/profile';\nimport { getSchemesForIosAsync } from '../../utils/scheme';\nimport { ensureNativeProjectAsync } from '../ensureNativeProject';\nimport { logProjectLogsLocation } from '../hints';\nimport { uploadRemoteBuildCache, resolveRemoteBuildCache } from '../remoteBuildCache';\nimport { startBundlerAsync } from '../startBundler';\nimport * as XcodeBuild from './XcodeBuild';\nimport { Options } from './XcodeBuild.types';\nimport { getLaunchInfoForBinaryAsync, launchAppAsync } from './launchApp';\nimport { resolveOptionsAsync } from './options/resolveOptions';\nimport { getValidBinaryPathAsync } from './validateExternalBinary';\nimport { exportEagerAsync } from '../../export/embed/exportEager';\nimport { getContainerPathAsync, simctlAsync } from '../../start/platforms/ios/simctl';\nimport { CommandError } from '../../utils/errors';\n\nconst debug = require('debug')('expo:run:ios');\n\nexport async function runIosAsync(projectRoot: string, options: Options) {\n  setNodeEnv(options.configuration === 'Release' ? 'production' : 'development');\n  require('@expo/env').load(projectRoot);\n\n  assertPlatform();\n\n  const install = !!options.install;\n\n  if ((await ensureNativeProjectAsync(projectRoot, { platform: 'ios', install })) && install) {\n    await maybePromptToSyncPodsAsync(projectRoot);\n  }\n\n  // Resolve the CLI arguments into useable options.\n  const props = await profile(resolveOptionsAsync)(projectRoot, options);\n\n  const projectConfig = getConfig(projectRoot);\n  if (!options.binary && projectConfig.exp.experiments?.remoteBuildCache && props.isSimulator) {\n    const localPath = await resolveRemoteBuildCache(projectRoot, {\n      platform: 'ios',\n      provider: projectConfig.exp.experiments?.remoteBuildCache.provider,\n      runOptions: options,\n    });\n    if (localPath) {\n      options.binary = localPath;\n    }\n  }\n\n  if (options.rebundle) {\n    Log.warn(`The --unstable-rebundle flag is experimental and may not work as expected.`);\n    // Get the existing binary path to re-bundle the app.\n\n    let binaryPath: string;\n    if (!options.binary) {\n      if (!props.isSimulator) {\n        throw new Error('Re-bundling on physical devices requires the --binary flag.');\n      }\n      const appId = await new AppleAppIdResolver(projectRoot).getAppIdAsync();\n      const possibleBinaryPath = await getContainerPathAsync(props.device, {\n        appId,\n      });\n      if (!possibleBinaryPath) {\n        throw new CommandError(\n          `Cannot rebundle because no --binary was provided and no existing binary was found on the device for ID: ${appId}.`\n        );\n      }\n      binaryPath = possibleBinaryPath;\n      Log.log('Re-using existing binary path:', binaryPath);\n      // Set the binary path to the existing binary path.\n      options.binary = binaryPath;\n    }\n\n    Log.log('Rebundling the Expo config file');\n    // Re-bundle the config file the same way the app was originally bundled.\n    await spawnAsync('node', [\n      path.join(require.resolve('expo-constants/package.json'), '../scripts/getAppConfig.js'),\n      projectRoot,\n      path.join(options.binary, 'EXConstants.bundle'),\n    ]);\n    // Re-bundle the app.\n\n    const possibleBundleOutput = path.join(options.binary, 'main.jsbundle');\n\n    if (fs.existsSync(possibleBundleOutput)) {\n      Log.log('Rebundling the app...');\n      await exportEagerAsync(projectRoot, {\n        resetCache: false,\n        dev: false,\n        platform: 'ios',\n        assetsDest: path.join(options.binary, 'assets'),\n        bundleOutput: possibleBundleOutput,\n      });\n    } else {\n      Log.warn('Bundle output not found at expected location:', possibleBundleOutput);\n    }\n  }\n\n  let binaryPath: string;\n  let shouldUpdateBuildCache = false;\n  if (options.binary) {\n    binaryPath = await getValidBinaryPathAsync(options.binary, props);\n    Log.log('Using custom binary path:', binaryPath);\n  } else {\n    let eagerBundleOptions: string | undefined;\n\n    if (options.configuration === 'Release') {\n      eagerBundleOptions = JSON.stringify(\n        await exportEagerAsync(projectRoot, {\n          dev: false,\n          platform: 'ios',\n        })\n      );\n    }\n\n    // Spawn the `xcodebuild` process to create the app binary.\n    const buildOutput = await XcodeBuild.buildAsync({\n      ...props,\n      eagerBundleOptions,\n    });\n\n    // Find the path to the built app binary, this will be used to install the binary\n    // on a device.\n    binaryPath = await profile(XcodeBuild.getAppBinaryPath)(buildOutput);\n    shouldUpdateBuildCache = true;\n  }\n  debug('Binary path:', binaryPath);\n\n  // Ensure the port hasn't become busy during the build.\n  if (props.shouldStartBundler && !(await ensurePortAvailabilityAsync(projectRoot, props))) {\n    props.shouldStartBundler = false;\n  }\n\n  const launchInfo = await getLaunchInfoForBinaryAsync(binaryPath);\n  const isCustomBinary = !!options.binary;\n\n  // Always close the app before launching on a simulator. Otherwise certain cached resources like the splashscreen will not be available.\n  if (props.isSimulator) {\n    try {\n      await simctlAsync(['terminate', props.device.udid, launchInfo.bundleId]);\n    } catch (error) {\n      // If we failed it's likely that the app was not running to begin with and we will get an `invalid device` error\n      debug('Failed to terminate app (possibly because it was not running):', error);\n    }\n  }\n\n  // Start the dev server which creates all of the required info for\n  // launching the app on a simulator.\n  const manager = await startBundlerAsync(projectRoot, {\n    port: props.port,\n    headless: !props.shouldStartBundler,\n    // If a scheme is specified then use that instead of the package name.\n\n    scheme: isCustomBinary\n      ? // If launching a custom binary, use the schemes in the Info.plist.\n        launchInfo.schemes[0]\n      : // If a scheme is specified then use that instead of the package name.\n        (await getSchemesForIosAsync(projectRoot))?.[0],\n  });\n\n  // Install and launch the app binary on a device.\n  await launchAppAsync(\n    binaryPath,\n    manager,\n    {\n      isSimulator: props.isSimulator,\n      device: props.device,\n      shouldStartBundler: props.shouldStartBundler,\n    },\n    launchInfo.bundleId\n  );\n\n  // Log the location of the JS logs for the device.\n  if (props.shouldStartBundler) {\n    logProjectLogsLocation();\n  } else {\n    await manager.stopAsync();\n  }\n\n  if (shouldUpdateBuildCache && projectConfig.exp.experiments?.remoteBuildCache) {\n    await uploadRemoteBuildCache(projectRoot, {\n      platform: 'ios',\n      provider: projectConfig.exp.experiments?.remoteBuildCache.provider,\n      buildPath: binaryPath,\n    });\n  }\n}\n\nfunction assertPlatform() {\n  if (process.platform !== 'darwin') {\n    Log.exit(\n      chalk`iOS apps can only be built on macOS devices. Use {cyan eas build -p ios} to build in the cloud.`\n    );\n  }\n}\n"],"names":["runIosAsync","debug","require","projectRoot","options","projectConfig","setNodeEnv","configuration","load","assertPlatform","install","ensureNativeProjectAsync","platform","maybePromptToSyncPodsAsync","props","profile","resolveOptionsAsync","getConfig","binary","exp","experiments","remoteBuildCache","isSimulator","localPath","resolveRemoteBuildCache","provider","runOptions","rebundle","Log","warn","binaryPath","Error","appId","AppleAppIdResolver","getAppIdAsync","possibleBinaryPath","getContainerPathAsync","device","CommandError","log","spawnAsync","path","join","resolve","possibleBundleOutput","fs","existsSync","exportEagerAsync","resetCache","dev","assetsDest","bundleOutput","shouldUpdateBuildCache","getValidBinaryPathAsync","eagerBundleOptions","JSON","stringify","buildOutput","XcodeBuild","buildAsync","getAppBinaryPath","shouldStartBundler","ensurePortAvailabilityAsync","launchInfo","getLaunchInfoForBinaryAsync","isCustomBinary","simctlAsync","udid","bundleId","error","manager","startBundlerAsync","port","headless","scheme","schemes","getSchemesForIosAsync","launchAppAsync","logProjectLogsLocation","stopAsync","uploadRemoteBuildCache","buildPath","process","exit","chalk"],"mappings":"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"}